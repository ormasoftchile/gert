{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://github.com/ormasoftchile/gert/schemas/runbook-v0.json",
  "$ref": "#/$defs/Runbook",
  "$defs": {
    "ApprovalRequirement": {
      "properties": {
        "min": {
          "type": "integer"
        },
        "roles": {
          "items": {
            "type": "string"
          },
          "type": "array"
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "Assertion": {
      "properties": {
        "contains": {
          "type": "string"
        },
        "not_contains": {
          "type": "string"
        },
        "matches": {
          "type": "string"
        },
        "exit_code": {
          "type": "integer"
        },
        "equals": {
          "type": "string"
        },
        "not_equals": {
          "type": "string"
        },
        "json_path": {
          "$ref": "#/$defs/JSONPathAssertion"
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "Branch": {
      "properties": {
        "condition": {
          "type": "string"
        },
        "label": {
          "type": "string"
        },
        "steps": {
          "items": {
            "$ref": "#/$defs/TreeNode"
          },
          "type": "array"
        }
      },
      "additionalProperties": false,
      "type": "object",
      "required": [
        "condition"
      ]
    },
    "CLIStepConfig": {
      "properties": {
        "argv": {
          "items": {
            "type": "string"
          },
          "type": "array",
          "minItems": 1
        }
      },
      "additionalProperties": false,
      "type": "object",
      "required": [
        "argv"
      ]
    },
    "ChoiceConfig": {
      "properties": {
        "variable": {
          "type": "string"
        },
        "prompt": {
          "type": "string"
        },
        "options": {
          "items": {
            "$ref": "#/$defs/ChoiceOption"
          },
          "type": "array",
          "minItems": 2
        }
      },
      "additionalProperties": false,
      "type": "object",
      "required": [
        "variable",
        "options"
      ]
    },
    "ChoiceOption": {
      "properties": {
        "value": {
          "type": "string"
        },
        "label": {
          "type": "string"
        },
        "description": {
          "type": "string"
        }
      },
      "additionalProperties": false,
      "type": "object",
      "required": [
        "value"
      ]
    },
    "Defaults": {
      "properties": {
        "timeout": {
          "type": "string",
          "pattern": "^[0-9]+(s|m|h)$"
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "EvidencePolicy": {
      "properties": {
        "require_for_manual": {
          "type": "boolean"
        },
        "store_full_stdout": {
          "type": "boolean"
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "EvidenceRequirement": {
      "properties": {
        "kind": {
          "type": "string",
          "enum": [
            "text",
            "checklist",
            "attachment"
          ]
        },
        "name": {
          "type": "string"
        },
        "items": {
          "items": {
            "type": "string"
          },
          "type": "array"
        }
      },
      "additionalProperties": false,
      "type": "object",
      "required": [
        "kind",
        "name"
      ]
    },
    "Gate": {
      "properties": {
        "stop_if": {
          "items": {
            "type": "string"
          },
          "type": "array"
        },
        "on_error": {
          "type": "string",
          "enum": [
            "skip"
          ]
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "GovernancePolicy": {
      "properties": {
        "allowed_commands": {
          "items": {
            "type": "string"
          },
          "type": "array"
        },
        "denied_commands": {
          "items": {
            "type": "string"
          },
          "type": "array"
        },
        "deny_env_vars": {
          "items": {
            "type": "string"
          },
          "type": "array"
        },
        "redact": {
          "items": {
            "$ref": "#/$defs/RedactionRule"
          },
          "type": "array"
        },
        "evidence": {
          "$ref": "#/$defs/EvidencePolicy"
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "InputDef": {
      "properties": {
        "from": {
          "type": "string"
        },
        "pattern": {
          "type": "string"
        },
        "description": {
          "type": "string"
        },
        "default": {
          "type": "string"
        },
        "example": {
          "type": "string"
        }
      },
      "additionalProperties": false,
      "type": "object",
      "required": [
        "from"
      ]
    },
    "InvokeConfig": {
      "properties": {
        "runbook": {
          "type": "string"
        },
        "inputs": {
          "additionalProperties": {
            "type": "string"
          },
          "type": "object"
        }
      },
      "additionalProperties": false,
      "type": "object",
      "required": [
        "runbook"
      ]
    },
    "IterateBlock": {
      "properties": {
        "max": {
          "type": "integer",
          "minimum": 1
        },
        "until": {
          "type": "string"
        },
        "over": {
          "type": "string"
        },
        "as": {
          "type": "string"
        },
        "steps": {
          "items": {
            "$ref": "#/$defs/TreeNode"
          },
          "type": "array",
          "minItems": 1
        }
      },
      "additionalProperties": false,
      "type": "object",
      "required": [
        "steps"
      ]
    },
    "JSONPathAssertion": {
      "properties": {
        "path": {
          "type": "string"
        },
        "equals": {
          "type": "string"
        }
      },
      "additionalProperties": false,
      "type": "object",
      "required": [
        "path",
        "equals"
      ]
    },
    "Meta": {
      "properties": {
        "name": {
          "type": "string"
        },
        "kind": {
          "type": "string",
          "enum": [
            "mitigation",
            "reference",
            "composable",
            "rca"
          ]
        },
        "description": {
          "type": "string"
        },
        "source": {
          "$ref": "#/$defs/SourceMeta"
        },
        "scenarios": {
          "additionalProperties": {
            "type": "string"
          },
          "type": "object"
        },
        "vars": {
          "additionalProperties": {
            "type": "string"
          },
          "type": "object"
        },
        "inputs": {
          "additionalProperties": {
            "$ref": "#/$defs/InputDef"
          },
          "type": "object"
        },
        "defaults": {
          "$ref": "#/$defs/Defaults"
        },
        "governance": {
          "$ref": "#/$defs/GovernancePolicy"
        },
        "prose": {
          "$ref": "#/$defs/Prose"
        }
      },
      "additionalProperties": false,
      "type": "object",
      "required": [
        "name"
      ]
    },
    "NextRunbook": {
      "properties": {
        "file": {
          "type": "string"
        },
        "inputs": {
          "additionalProperties": {
            "type": "string"
          },
          "type": "object"
        }
      },
      "additionalProperties": false,
      "type": "object",
      "required": [
        "file"
      ]
    },
    "Outcome": {
      "properties": {
        "when": {
          "type": "string"
        },
        "state": {
          "type": "string",
          "enum": [
            "resolved",
            "escalated",
            "no_action",
            "needs_rca"
          ]
        },
        "recommendation": {
          "type": "string"
        },
        "next_runbook": {
          "$ref": "#/$defs/NextRunbook"
        }
      },
      "additionalProperties": false,
      "type": "object",
      "required": [
        "state"
      ]
    },
    "Precondition": {
      "properties": {
        "check": {
          "items": {
            "type": "string"
          },
          "type": "array",
          "minItems": 1
        },
        "skip_if_succeeds": {
          "type": "boolean"
        },
        "message": {
          "type": "string"
        }
      },
      "additionalProperties": false,
      "type": "object",
      "required": [
        "check",
        "skip_if_succeeds"
      ]
    },
    "Prose": {
      "properties": {
        "background": {
          "type": "string"
        },
        "safety": {
          "type": "string"
        },
        "prerequisites": {
          "type": "string"
        },
        "post_mitigation": {
          "type": "string"
        },
        "references": {
          "items": {
            "$ref": "#/$defs/ProseReference"
          },
          "type": "array"
        },
        "ownership": {
          "$ref": "#/$defs/ProseOwnership"
        },
        "notes": {
          "type": "string"
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "ProseOwnership": {
      "properties": {
        "team": {
          "type": "string"
        },
        "email": {
          "type": "string"
        }
      },
      "additionalProperties": false,
      "type": "object",
      "required": [
        "team"
      ]
    },
    "ProseReference": {
      "properties": {
        "title": {
          "type": "string"
        },
        "url": {
          "type": "string"
        }
      },
      "additionalProperties": false,
      "type": "object",
      "required": [
        "title",
        "url"
      ]
    },
    "RedactionRule": {
      "properties": {
        "pattern": {
          "type": "string"
        },
        "replace": {
          "type": "string"
        }
      },
      "additionalProperties": false,
      "type": "object",
      "required": [
        "pattern",
        "replace"
      ]
    },
    "Runbook": {
      "properties": {
        "apiVersion": {
          "type": "string",
          "enum": [
            "runbook/v0",
            "runbook/v1"
          ]
        },
        "imports": {
          "additionalProperties": {
            "type": "string"
          },
          "type": "object"
        },
        "tools": {
          "items": {
            "type": "string"
          },
          "type": "array"
        },
        "meta": {
          "$ref": "#/$defs/Meta"
        },
        "steps": {
          "items": {
            "$ref": "#/$defs/Step"
          },
          "type": "array"
        },
        "tree": {
          "items": {
            "$ref": "#/$defs/TreeNode"
          },
          "type": "array"
        }
      },
      "additionalProperties": false,
      "type": "object",
      "required": [
        "apiVersion",
        "meta"
      ]
    },
    "SourceMeta": {
      "properties": {
        "file": {
          "type": "string"
        },
        "compiled_at": {
          "type": "string"
        },
        "compiled_by": {
          "type": "string"
        },
        "model": {
          "type": "string"
        },
        "source_hash": {
          "type": "string"
        }
      },
      "additionalProperties": false,
      "type": "object",
      "required": [
        "file",
        "compiled_at"
      ]
    },
    "Step": {
      "properties": {
        "id": {
          "type": "string"
        },
        "type": {
          "type": "string",
          "enum": [
            "cli",
            "manual",
            "invoke",
            "tool"
          ]
        },
        "title": {
          "type": "string"
        },
        "when": {
          "type": "string"
        },
        "precondition": {
          "$ref": "#/$defs/Precondition"
        },
        "outcomes": {
          "items": {
            "$ref": "#/$defs/Outcome"
          },
          "type": "array"
        },
        "with": {
          "$ref": "#/$defs/CLIStepConfig"
        },
        "instructions": {
          "type": "string"
        },
        "required_evidence": {
          "items": {
            "$ref": "#/$defs/EvidenceRequirement"
          },
          "type": "array"
        },
        "approvals": {
          "$ref": "#/$defs/ApprovalRequirement"
        },
        "choices": {
          "$ref": "#/$defs/ChoiceConfig"
        },
        "capture": {
          "additionalProperties": {
            "type": "string"
          },
          "type": "object"
        },
        "assertions": {
          "items": {
            "$ref": "#/$defs/Assertion"
          },
          "type": "array"
        },
        "timeout": {
          "type": "string",
          "pattern": "^[0-9]+(s|m|h)$"
        },
        "delay": {
          "type": "string",
          "pattern": "^[0-9]+(ms|s|m|h)$"
        },
        "replay_mode": {
          "type": "string",
          "enum": [
            "reuse_evidence"
          ]
        },
        "invoke": {
          "$ref": "#/$defs/InvokeConfig"
        },
        "gate": {
          "$ref": "#/$defs/Gate"
        },
        "tool": {
          "$ref": "#/$defs/ToolStepConfig"
        }
      },
      "additionalProperties": false,
      "type": "object",
      "required": [
        "id",
        "type"
      ]
    },
    "ToolStepConfig": {
      "properties": {
        "name": {
          "type": "string"
        },
        "action": {
          "type": "string"
        },
        "args": {
          "additionalProperties": {
            "type": "string"
          },
          "type": "object"
        }
      },
      "additionalProperties": false,
      "type": "object",
      "required": [
        "name",
        "action"
      ]
    },
    "TreeNode": {
      "properties": {
        "step": {
          "$ref": "#/$defs/Step"
        },
        "iterate": {
          "$ref": "#/$defs/IterateBlock"
        },
        "branches": {
          "items": {
            "$ref": "#/$defs/Branch"
          },
          "type": "array"
        }
      },
      "additionalProperties": false,
      "type": "object"
    }
  },
  "title": "Governed Executable Runbook v0",
  "description": "Schema for gert runbook YAML documents (Draft 2020-12)"
}