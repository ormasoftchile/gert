apiVersion: runbook/v0
meta:
    name: pod-crashloopbackoff-investigation
    description: Investigate Kubernetes pods stuck in CrashLoopBackOff by checking status, logs, events, and validating monitoring signals.
    vars:
        namespace: ""
        service: ""
    governance:
        allowed_commands:
            - kubectl
        evidence:
            require_for_manual: true
            store_full_stdout: false
steps:
    - id: check_pod_status
      type: cli
      title: Check Pod Status
      with:
        argv:
            - kubectl
            - get
            - pods
            - -n
            - '{{ .namespace }}'
            - -l
            - app={{ .service }}
      capture:
        output: stdout
    - id: get_pod_logs
      type: cli
      title: Get Pod Logs
      with:
        argv:
            - kubectl
            - logs
            - -n
            - '{{ .namespace }}'
            - -l
            - app={{ .service }}
            - --tail=100
      capture:
        output: stdout
    - id: check_cluster_events
      type: cli
      title: Check Events
      with:
        argv:
            - kubectl
            - get
            - events
            - -n
            - '{{ .namespace }}'
            - --sort-by=.lastTimestamp
      capture:
        output: stdout
    - id: validate_monitoring_dashboard
      type: manual
      title: Validate Monitoring Dashboard
      instructions: |
        Open the Grafana dashboard for the service and confirm the following conditions are met:
        - Error rate is below 1%
        - P99 latency is below 500ms
        - No anomalous traffic patterns

        Take a screenshot of the dashboard for evidence.
      required_evidence:
        - kind: checklist
          name: dashboard_validation
          items:
            - Error rate below 1%
            - P99 latency below 500ms
            - No anomalous traffic patterns
        - kind: attachment
          name: grafana_dashboard_screenshot
          items: []
